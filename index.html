<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI é…å°é¡Œåº«ç”ŸæˆåŠç®¡ç†å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease-in-out;
            opacity: 0;
        }
        .modal-backdrop.show {
            display: flex;
            opacity: 1;
        }
        /* è¼‰å…¥å‹•ç•« */
        .loader {
            width: 50px;
            aspect-ratio: 1;
            border-radius: 50%;
            border: 8px solid #0000;
            border-right-color: #4f46e5; /* indigo-600 */
            position: relative;
            animation: l24 1s infinite linear;
        }
        .loader:before,
        .loader:after {
            content: "";
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: inherit;
            animation: inherit;
            animation-duration: 2s;
        }
        .loader:after {
            animation-duration: 4s;
        }
        @keyframes l24 {
            100% {transform: rotate(1turn)}
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl relative">
        <!-- Settings Button -->
        <div class="absolute top-4 right-4 z-10">
            <button id="settings-btn" class="bg-white p-2 rounded-full text-2xl shadow-md hover:bg-gray-200 transition-colors" title="è¨­å®š AI ä¾†æº">âš™ï¸</button>
        </div>

        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-12">
            <h1 class="text-5xl md:text-6xl font-black text-gray-800">
                AI é…å°é¡Œåº«ç”Ÿæˆå·¥å…·
            </h1>
            <p class="text-lg text-gray-500 mt-2">ä¸€å€‹ç°¡å–®åˆå¼·å¤§çš„æ—èªé…å°é¡Œåº«ç”Ÿæˆå™¨</p>
        </header>

        <main class="max-w-6xl mx-auto">
            <!-- é ‚éƒ¨æ“ä½œæŒ‰éˆ•å€ -->
            <div class="flex justify-center gap-4 mb-8">
                <button id="open-material-modal" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg text-lg font-bold flex items-center gap-2 shadow-sm transition-colors">
                    ğŸ¤– AI ç”Ÿæˆé¡Œåº«
                </button>
                <button id="open-batch-add-modal" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg text-lg font-bold flex items-center gap-2 shadow-sm transition-colors">
                    âœï¸ æ‰‹å‹•å»ºç«‹é¡Œåº«
                </button>
                <button id="open-data-modal" class="bg-gray-700 hover:bg-gray-800 text-white px-6 py-3 rounded-lg text-lg font-bold flex items-center gap-2 shadow-sm transition-colors">
                    ğŸ’¾ è³‡æ–™ç®¡ç†
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- å·¦å´ï¼šæˆ‘çš„é¡Œåº« -->
                <section id="bank-section">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-3xl font-bold mb-4 flex items-center text-gray-700">
                            <span class="text-white bg-green-500 rounded-lg w-10 h-10 flex items-center justify-center text-xl mr-3">ğŸ“š</span>
                            æˆ‘çš„é¡Œåº«
                        </h2>
                        <div id="bank-list">
                            <!-- é¡Œåº«åˆ—è¡¨å°‡å‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
                        </div>
                    </div>
                </section>

                <!-- å³å´ï¼šå‡ºé¡Œèˆ‡åŒ¯å‡º -->
                <section id="output-section">
                     <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-3xl font-bold mb-4 flex items-center text-gray-700">
                            <span class="text-white bg-red-500 rounded-lg w-10 h-10 flex items-center justify-center text-xl mr-3">ğŸ¯</span>
                            ç”Ÿæˆç·´ç¿’èˆ‡åŒ¯å‡º
                        </h2>
                        <div id="quiz-generator">
                             <div class="bg-gray-50 p-4 border border-gray-200 rounded-lg">
                                <p class="font-bold text-lg mb-2 text-gray-600">è«‹å…ˆå¾å·¦å´é¸æ“‡è¦ä½¿ç”¨çš„é¡Œåº«ã€‚</p>
                                <div id="auto-generate-options">
                                    <div class="mb-4">
                                        <label for="num-pairs" class="font-bold text-gray-700">ç¸½é¡Œæ•¸ (é…å°çµ„æ•¸)ï¼š</label>
                                        <input type="number" id="num-pairs" value="10" min="1" class="border-gray-300 rounded-md shadow-sm w-24 p-2 text-center focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                    <button id="generate-quiz-btn-auto" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 text-lg rounded-lg font-semibold transition-colors disabled:bg-gray-300" disabled>è‡ªå‹•å‡ºé¡Œ</button>
                                    <button id="generate-quiz-btn-manual" class="w-full bg-teal-500 hover:bg-teal-600 text-white py-2 text-lg rounded-lg font-semibold transition-colors disabled:bg-gray-300" disabled>æ‰‹å‹•é¸é¡Œ</button>
                                </div>
                             </div>
                        </div>
                                                
                        <div id="quiz-preview" class="mt-6 hidden">
                             <h3 class="text-2xl font-bold mb-2 text-gray-700">ç·´ç¿’é¡Œé è¦½</h3>
                             <div id="quiz-preview-list" class="bg-gray-50 p-4 border border-gray-200 rounded-lg max-h-96 overflow-y-auto">
                                <!-- é è¦½é¡Œç›®å°‡é¡¯ç¤ºæ–¼æ­¤ -->
                             </div>
                             <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <h4 class="font-bold text-yellow-800 mb-2">åŒ¯å‡ºè¨­å®š</h4>
                                <p class="mb-2 text-gray-700">åŒ¯å‡ºæ™‚ï¼Œå“ªä¸€æ¬„è¦æ”¾åœ¨å‰é¢ï¼Ÿ</p>
                                <div class="flex gap-4">
                                    <label class="flex items-center"><input type="radio" name="export-order" value="col1_first" checked class="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"> é …ç›®1 åœ¨å‰</label>
                                    <label class="flex items-center"><input type="radio" name="export-order" value="col2_first" class="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"> é …ç›®2 åœ¨å‰</label>
                                </div>
                             </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <button id="export-wordwall-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg font-semibold transition-colors">åŒ¯å‡º Wordwall</button>
                                <button id="export-game-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white py-2 rounded-lg font-semibold transition-colors">åŒ¯å‡ºéŠæˆ² HTML</button>
                             </div>
                        </div>
                     </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="loading-modal" class="modal-backdrop">
        <div class="flex flex-col items-center justify-center">
            <div class="loader"></div>
            <p id="loading-text" class="text-white text-2xl font-bold mt-6">AI æ­£åœ¨åŠªåŠ›ç‚ºæ‚¨ç”Ÿæˆé…å°é¡Œ...</p>
        </div>
    </div>

    <div id="edit-bank-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl h-5/6 flex flex-col">
            <h2 id="edit-modal-title" class="text-2xl font-bold p-4 border-b border-gray-200">ç·¨è¼¯é¡Œåº«</h2>
            <div id="edit-modal-content" class="p-6 overflow-y-auto flex-grow"></div>
            <div class="p-4 border-t border-gray-200 flex justify-end space-x-4 bg-gray-50">
                <button class="modal-cancel-btn bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition-colors">å–æ¶ˆ</button>
                <button id="edit-modal-save" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>
    
    <div id="batch-add-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-3xl flex flex-col max-h-[90vh]">
            <h2 class="text-2xl font-bold p-4 border-b border-gray-200">æ‰‹å‹•å»ºç«‹æ–°é¡Œåº«</h2>
            <div class="p-6 overflow-y-auto flex-grow space-y-4">
                <div>
                    <label for="new-bank-name" class="font-bold text-gray-700">æ–°é¡Œåº«åç¨±:</label>
                    <input type="text" id="new-bank-name" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šæ—èªé«˜é »å–®å­— (ç¬¬ä¸€èª²)">
                </div>
                 <div>
                    <label for="col1-name" class="font-bold text-gray-700">é …ç›®1 æ¬„ä½åç¨±:</label>
                    <input type="text" id="col1-name" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šæ—èªå–®å­—">
                </div>
                 <div>
                    <label for="col2-name" class="font-bold text-gray-700">é …ç›®2 æ¬„ä½åç¨±:</label>
                    <input type="text" id="col2-name" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šä¸­æ–‡ç¿»è­¯">
                </div>
                <div>
                    <label for="batch-input-text" class="font-bold text-gray-700">è²¼ä¸Šé…å°å…§å®¹:</label>
                    <textarea id="batch-input-text" class="w-full h-48 border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="æ ¼å¼ï¼šé …ç›®1,é …ç›®2 (ä¸€è¡Œä¸€çµ„)&#10;ä¾‹å¦‚ï¼š&#10;apple,è˜‹æœ&#10;banana,é¦™è•‰"></textarea>
                    <p class="text-sm text-gray-600 mt-1">æ¯ä¸€è¡Œä»£è¡¨ä¸€çµ„é…å°ã€‚è«‹ä½¿ç”¨é€—è™Ÿ , åˆ†éš”å…©å€‹é …ç›®ã€‚</p>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end space-x-4 bg-gray-50">
                <button class="modal-cancel-btn bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition-colors">å–æ¶ˆ</button>
                <button id="batch-add-save" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">å»ºç«‹é¡Œåº«</button>
            </div>
        </div>
    </div>

    <div id="material-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-3xl flex flex-col max-h-[90vh]">
            <h2 class="text-2xl font-bold p-4 border-b border-gray-200">AI ç”Ÿæˆé¡Œåº«</h2>
            <div class="p-6 overflow-y-auto flex-grow space-y-4">
                <div>
                    <label for="ai-text-input" class="font-bold text-gray-700">æ•™ææ–‡å­—ä¾†æºï¼š</label>
                    <textarea id="ai-text-input" class="w-full h-48 border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="åœ¨æ­¤è²¼ä¸Šæ–‡å­—ï¼Œæˆ–å¾ä¸‹æ–¹ä¸Šå‚³æª”æ¡ˆè‡ªå‹•æ“·å–..."></textarea>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border-2 border-dashed">
                    <label for="file-input" class="font-bold text-gray-700">æˆ–ä¸Šå‚³æª”æ¡ˆè‡ªå‹•æ“·å–æ–‡å­— (æ”¯æ´ PDF, PNG, JPG)ï¼š</label>
                    <input type="file" id="file-input" class="w-full mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept=".pdf,.png,.jpg,.jpeg">
                    <p class="text-sm text-gray-600 mt-2">ä¸Šå‚³å¾Œæ–‡å­—å°‡è‡ªå‹•å¡«å…¥ä¸Šæ–¹æ–‡å­—æ¡†ã€‚</p>
                </div>
                <hr class="my-2 border-dashed border-gray-300"/>
                <div class="space-y-4">
                    <div>
                        <label for="ai-bank-name" class="font-bold text-gray-700">æ–°é¡Œåº«åç¨±:</label>
                        <input type="text" id="ai-bank-name" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šèª²æ–‡é‡è¦è©å½™ (å¯ç”±æª”åè‡ªå‹•å¸¶å…¥)">
                    </div>
                    <div>
                        <label for="ai-pair-type" class="font-bold text-gray-700">æ‚¨æƒ³ç”Ÿæˆå“ªç¨®é¡å‹çš„é…å°ï¼Ÿ</label>
                        <input type="text" id="ai-pair-type" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šæ—èªå–®å­—èˆ‡ä¸­æ–‡ç¿»è­¯ã€å°ˆæœ‰åè©èˆ‡å…¶è§£é‡‹">
                        <div class="flex flex-wrap gap-2 mt-2">
                            <button class="preset-btn bg-gray-200 hover:bg-gray-300 text-sm px-3 py-1 rounded-full font-semibold transition-colors">æ—èªå–®å­—èˆ‡ä¸­æ–‡ç¿»è­¯</button>
                            <button class="preset-btn bg-gray-200 hover:bg-gray-300 text-sm px-3 py-1 rounded-full font-semibold transition-colors">å°ˆæœ‰åè©èˆ‡å…¶è§£é‡‹</button>
                            <button class="preset-btn bg-gray-200 hover:bg-gray-300 text-sm px-3 py-1 rounded-full font-semibold transition-colors">åœ‹å­—èˆ‡æ³¨éŸ³</button>
                            <button class="preset-btn bg-gray-200 hover:bg-gray-300 text-sm px-3 py-1 rounded-full font-semibold transition-colors">æˆèªèˆ‡è§£é‡‹</button>
                        </div>
                    </div>
                    <div>
                        <label for="ai-num-pairs" class="font-bold text-gray-700">å¸Œæœ›ç”Ÿæˆå¹¾çµ„é…å°ï¼Ÿ</label>
                        <input type="number" id="ai-num-pairs" value="15" min="1" max="50" class="border-gray-300 rounded-md shadow-sm w-24 p-2 text-center mt-1 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end space-x-4 bg-gray-50">
                <button class="modal-cancel-btn bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition-colors">å–æ¶ˆ</button>
                <button id="generate-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">é–‹å§‹ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <div id="data-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-2xl flex flex-col">
            <h2 class="text-2xl font-bold p-4 border-b border-gray-200">è³‡æ–™ç®¡ç†</h2>
            <div class="p-6 overflow-y-auto flex-grow">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="import-data-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-black py-3 rounded-lg text-lg font-semibold transition-colors">ğŸ“¥ åŒ¯å…¥é¡Œåº« (.csv)</button>
                    <button id="export-data-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white py-3 rounded-lg text-lg font-semibold transition-colors">ğŸ“¤ åŒ¯å‡ºå…¨éƒ¨è³‡æ–™ (.csv)</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".csv,text/csv">
                </div>
                <div id="csv-sample-link-container" class="mt-4 text-center text-sm text-gray-600"></div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end bg-gray-50">
                <button class="modal-cancel-btn bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition-colors">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="game-select-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-3xl flex flex-col">
            <h2 class="text-2xl font-bold p-4 border-b border-gray-200">é¸æ“‡éŠæˆ²é¡å‹</h2>
            <div class="p-6 overflow-y-auto flex-grow">
                <p class="text-gray-600 mb-4">è«‹é¸æ“‡è¦åŒ¯å‡ºçš„éŠæˆ²ï¼Œé¡Œåº«å°‡è‡ªå‹•å¡«å…¥ï¼š</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button class="game-option-btn h-full w-full text-left bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg transition-colors" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/æ™®æ™®é¢¨é…å°éŠæˆ²New/æ™®æ™®é¢¨é…å°éŠæˆ².html">
                        <h3 class="font-bold text-lg">ğŸ¨ æ™®æ™®é¢¨é…å°éŠæˆ²</h3>
                        <p class="text-sm">ç¶“å…¸çš„ç¿»ç‰Œé…å°è¨˜æ†¶éŠæˆ²ã€‚</p>
                    </button>
                    <button class="game-option-btn h-full w-full text-left bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg transition-colors" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/ä¸­è‹±æ‰“é—–é—œéŠæˆ²/ä¸­è‹±æ‰“é—–é—œéŠæˆ².html">
                        <h3 class="font-bold text-lg">âŒ¨ï¸ ä¸­è‹±æ‰“é—–é—œéŠæˆ²</h3>
                        <p class="text-sm">æ ¹æ“šæç¤ºè©è¼¸å…¥æ­£ç¢ºç­”æ¡ˆçš„æ‰“å­—éŠæˆ²ã€‚</p>
                    </button>
                     <button class="game-option-btn h-full w-full text-left bg-yellow-500 hover:bg-yellow-600 text-black p-4 rounded-lg transition-colors" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/æ™®æ™®é¢¨å–®å­—å­¸ç¿’æ©Ÿ-æœ¬æ©Ÿç‰ˆ/æ™®æ™®é¢¨å–®å­—å­¸ç¿’æ©Ÿ.html">
                        <h3 class="font-bold text-lg">ğŸ“– æ™®æ™®é¢¨æ—èªå–®å­—å­¸ç¿’æ©Ÿ</h3>
                        <p class="text-sm">è®“å­¸ç”Ÿä½¿ç”¨å¹³æ¿ç·´ç¿’èƒŒæ—èªå–®å­—çš„éŠæˆ²ã€‚</p>
                    </button>
                    <button class="game-option-btn h-full w-full text-left bg-red-500 hover:bg-red-600 text-white p-4 rounded-lg transition-colors" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/è‹±æ‰“ç·´ç¿’/è‹±æ‰“ç·´ç¿’-è‡ªè¨‚å–®å­—ç‰ˆ.html">
                        <h3 class="font-bold text-lg">ğŸ‡¬ğŸ‡§ å–®å­—è‹±æ‰“ç·´ç¿’</h3>
                        <p class="text-sm">åŸºç¤çš„æ—èªå–®å­—æ‰“å­—ç·´ç¿’ã€‚</p>
                    </button>
                    <button class="game-option-btn h-full w-full text-left bg-indigo-500 hover:bg-indigo-600 text-white p-4 rounded-lg md:col-span-2 transition-colors" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/ä¸­æ‰“ç·´ç¿’/ä¸­æ‰“ç·´ç¿’-è‡ªè¨‚å–®å­—ç‰ˆ.html">
                        <h3 class="font-bold text-lg">ğŸ‡¹ğŸ‡¼ è©èªä¸­æ‰“ç·´ç¿’</h3>
                        <p class="text-sm">åŸºç¤çš„ä¸­æ–‡è©èªæ‰“å­—ç·´ç¿’ã€‚</p>
                    </button>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end bg-gray-50">
                <button class="modal-cancel-btn bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition-colors">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-2xl flex flex-col">
            <h2 class="text-2xl font-bold p-4 border-b border-gray-200">AI ä¾†æºè¨­å®š</h2>
            <div class="p-6 overflow-y-auto flex-grow space-y-6">
                <!-- AI Source Selection -->
                <div>
                    <label class="font-bold text-lg text-gray-700">é¸æ“‡ AI ä¾†æº:</label>
                    <div class="mt-2 space-y-2">
                        <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-400 cursor-pointer">
                            <input type="radio" name="ai-source" value="default" class="h-5 w-5 mr-3 text-indigo-600 focus:ring-indigo-500">
                            <div>
                                <p class="font-bold">é è¨­ Gemini</p>
                                <p class="text-sm text-gray-600">ä½¿ç”¨å…§å»ºçš„ Gemini æ¨¡å‹ï¼Œç„¡éœ€è¨­å®šã€‚</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-400 cursor-pointer">
                            <input type="radio" name="ai-source" value="gemini_api" class="h-5 w-5 mr-3 text-indigo-600 focus:ring-indigo-500">
                            <div>
                                <p class="font-bold">Gemini API Key</p>
                                <p class="text-sm text-gray-600">ä½¿ç”¨æ‚¨è‡ªå·±çš„ Google AI Gemini API é‡‘é‘°ã€‚</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-400 cursor-pointer">
                            <input type="radio" name="ai-source" value="ollama" class="h-5 w-5 mr-3 text-indigo-600 focus:ring-indigo-500">
                            <div>
                                <p class="font-bold">æœ¬åœ° Ollama</p>
                                <p class="text-sm text-gray-600">é€£æ¥åˆ°æ‚¨åœ¨æœ¬åœ°é‹è¡Œçš„ Ollama æœå‹™ã€‚</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Gemini API Key Section -->
                <div id="gemini-api-settings" class="hidden pl-8">
                    <label for="gemini-api-key" class="font-bold text-gray-700">æ‚¨çš„ Gemini API Key:</label>
                    <input type="password" id="gemini-api-key" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key">
                </div>

                <!-- Ollama Section -->
                <div id="ollama-settings" class="hidden pl-8 space-y-4">
                    <div>
                        <label for="ollama-url" class="font-bold text-gray-700">Ollama URL:</label>
                        <input type="text" id="ollama-url" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚: http://localhost:11434">
                    </div>
                    <div>
                        <label for="ollama-model" class="font-bold text-gray-700">é¸æ“‡æ¨¡å‹:</label>
                        <div class="flex items-center gap-2 mt-1">
                            <select id="ollama-model" class="w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">è«‹å…ˆç²å–æ¨¡å‹åˆ—è¡¨</option>
                            </select>
                            <button id="fetch-ollama-models-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg flex-shrink-0 font-semibold hover:bg-indigo-600 transition-colors">ç²å–</button>
                        </div>
                         <p id="ollama-status" class="text-sm text-gray-500 mt-1 h-4"></p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end space-x-4 bg-gray-50">
                <button class="modal-cancel-btn bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition-colors">å–æ¶ˆ</button>
                <button id="settings-save" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <div id="manual-select-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl h-5/6 flex flex-col">
            <h2 class="text-2xl font-bold p-4 border-b border-gray-200">æ‰‹å‹•é¸æ“‡é¡Œç›®</h2>
            <div id="manual-select-content" class="p-6 overflow-y-auto flex-grow">
                <!-- Pairs will be dynamically added here -->
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end space-x-4 bg-gray-50">
                <button class="modal-cancel-btn bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition-colors">å–æ¶ˆ</button>
                <button id="manual-select-done" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">å®Œæˆé¸é¡Œ</button>
            </div>
        </div>
    </div>
    
    <div id="alert-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md flex flex-col">
            <h2 id="alert-title" class="text-xl font-bold p-4 border-b border-gray-200">æç¤º</h2>
            <div class="p-6">
                <p id="alert-message"></p>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end bg-gray-50">
                <button id="alert-ok-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md flex flex-col">
            <h2 id="confirm-title" class="text-xl font-bold p-4 border-b border-gray-200">è«‹ç¢ºèª</h2>
            <div class="p-6">
                <p id="confirm-message"></p>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end space-x-4 bg-gray-50">
                <button id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition-colors">å–æ¶ˆ</button>
                <button id="confirm-ok-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">ç¢ºå®š</button>
            </div>
        </div>
    </div>


    <script>
    const app = {
        db: null,
        questionBanks: [],
        selectedBankIds: new Set(),
        currentQuiz: [],
        settings: {
            aiSource: 'default', // 'default', 'gemini_api', 'ollama'
            geminiApiKey: '',
            ollamaUrl: 'http://localhost:11434',
            ollamaModel: ''
        },

        init() {
            if (window.pdfjsLib) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            this.loadSettings();
            this.initDB();
            this.addEventListeners();
            this.createSampleCSVLink();
        },
        
        showAlert(message, title = 'æç¤º') {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            const okBtn = document.getElementById('alert-ok-btn');
            
            const close = () => this.closeModal('alert-modal');
            
            // Clone and replace the button to remove old event listeners
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            newOkBtn.addEventListener('click', close);

            this.openModal('alert-modal');
        },

        showConfirm(message, title = 'è«‹ç¢ºèª') {
            return new Promise(resolve => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;

                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                
                const close = () => this.closeModal('confirm-modal');
                
                const onOk = () => {
                    close();
                    resolve(true);
                };
                
                const onCancel = () => {
                    close();
                    resolve(false);
                };

                // Clone and replace buttons to remove old listeners
                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                newOkBtn.addEventListener('click', onOk);
                
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                newCancelBtn.addEventListener('click', onCancel);

                this.openModal('confirm-modal');
            });
        },


        initDB() {
            const request = indexedDB.open('MatchingQuizDB', 1);
            request.onerror = (event) => console.error("Database error: " + event.target.errorCode);
            request.onsuccess = (event) => {
                this.db = event.target.result;
                this.loadBanksFromDB();
            };
            request.onupgradeneeded = (event) => {
                let db = event.target.result;
                db.createObjectStore("questionBanks", { keyPath: "id" });
            };
        },

        addEventListeners() {
            // Main buttons
            document.getElementById('open-material-modal').addEventListener('click', () => this.openModal('material-modal'));
            document.getElementById('open-batch-add-modal').addEventListener('click', () => this.openModal('batch-add-modal'));
            document.getElementById('open-data-modal').addEventListener('click', () => this.openModal('data-modal'));
            document.getElementById('settings-btn').addEventListener('click', () => this.openSettingsModal());

            // Modal Cancel Buttons
            document.querySelectorAll('.modal-cancel-btn').forEach(btn => {
                btn.addEventListener('click', (e) => this.closeAllModals());
            });

            // Specific Modal Save/Action Buttons
            document.getElementById('generate-btn').addEventListener('click', () => this.handleAIGenerate());
            document.getElementById('batch-add-save').addEventListener('click', () => this.handleBatchAdd());
            document.getElementById('settings-save').addEventListener('click', () => this.saveSettings());
            document.querySelectorAll('input[name="ai-source"]').forEach(radio => {
                radio.addEventListener('change', () => this.updateSettingsUI());
            });
            document.getElementById('fetch-ollama-models-btn').addEventListener('click', () => this.fetchOllamaModels());
            document.getElementById('edit-modal-save').addEventListener('click', () => this.saveBankEdits());
            document.getElementById('manual-select-done').addEventListener('click', () => this.generateManualQuiz());

            // AI Gen Modal File Input
            document.getElementById('file-input').addEventListener('change', (e) => this.handleFileUpload(e));

            // AI Gen preset buttons
            document.querySelectorAll('#material-modal .preset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('ai-pair-type').value = e.target.textContent;
                });
            });

            // Quiz Generation & Export
            document.getElementById('generate-quiz-btn-auto').addEventListener('click', () => this.generatePracticeQuiz('auto'));
            document.getElementById('generate-quiz-btn-manual').addEventListener('click', () => this.generatePracticeQuiz('manual'));
            document.getElementById('export-wordwall-btn').addEventListener('click', () => this.exportQuiz('wordwall'));
            document.getElementById('export-game-btn').addEventListener('click', () => this.openGameSelectModal());

            // Game select modal buttons
            document.querySelectorAll('#game-select-modal .game-option-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const url = e.currentTarget.dataset.url;
                    this.downloadGameWithQuiz(url);
                });
            });

            // Data Management
            document.getElementById('export-data-btn').addEventListener('click', () => this.exportAllData());
            document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', (event) => this.importAllData(event));
        },
        
        // --- Modal Management ---
        openModal(modalId) {
            // Close any other open modals first to prevent overlap issues
            this.closeAllModals(true); // silent close
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
            }
        },
        
        closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        },

        openGameSelectModal() {
            if (this.currentQuiz.length === 0) {
                this.showAlert('è«‹å…ˆç”Ÿæˆç·´ç¿’é¡Œï¼');
                return;
            }
            this.openModal('game-select-modal');
        },

        openSettingsModal() {
            document.querySelector(`input[name="ai-source"][value="${this.settings.aiSource}"]`).checked = true;
            document.getElementById('gemini-api-key').value = this.settings.geminiApiKey;
            document.getElementById('ollama-url').value = this.settings.ollamaUrl;
            
            const modelSelect = document.getElementById('ollama-model');
            modelSelect.innerHTML = `<option value="">è«‹å…ˆç²å–æ¨¡å‹åˆ—è¡¨</option>`;
            if (this.settings.aiSource === 'ollama' && this.settings.ollamaModel) {
                modelSelect.innerHTML = `<option value="${this.settings.ollamaModel}" selected>${this.settings.ollamaModel}</option>`;
            }

            this.updateSettingsUI();
            this.openModal('settings-modal');
        },

        closeAllModals(silent = false) {
            document.querySelectorAll('.modal-backdrop.show').forEach(modal => {
                if (!silent || (modal.id !== 'alert-modal' && modal.id !== 'confirm-modal')) {
                    modal.classList.remove('show');
                }
            });
        },


        showLoading(message) {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-modal').classList.add('show');
        },
        
        hideLoading() {
            document.getElementById('loading-modal').classList.remove('show');
        },

        // --- Settings ---
        loadSettings() {
            const savedSettings = localStorage.getItem('aiMatchingQuizSettings');
            if (savedSettings) {
                this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
            }
        },

        saveSettings() {
            this.settings.aiSource = document.querySelector('input[name="ai-source"]:checked').value;
            this.settings.geminiApiKey = document.getElementById('gemini-api-key').value.trim();
            this.settings.ollamaUrl = document.getElementById('ollama-url').value.trim();
            this.settings.ollamaModel = document.getElementById('ollama-model').value;
            localStorage.setItem('aiMatchingQuizSettings', JSON.stringify(this.settings));
            this.showAlert('è¨­å®šå·²å„²å­˜ï¼');
            this.closeAllModals();
        },
        
        updateSettingsUI() {
            const source = document.querySelector('input[name="ai-source"]:checked').value;
            document.getElementById('gemini-api-settings').classList.toggle('hidden', source !== 'gemini_api');
            document.getElementById('ollama-settings').classList.toggle('hidden', source !== 'ollama');
        },

        async fetchOllamaModels() {
            const url = document.getElementById('ollama-url').value.trim();
            if (!url) {
                this.showAlert('è«‹å…ˆè¼¸å…¥ Ollama URLã€‚');
                return;
            }
            const statusEl = document.getElementById('ollama-status');
            const selectEl = document.getElementById('ollama-model');
            statusEl.textContent = 'æ­£åœ¨ç²å–æ¨¡å‹...';
            selectEl.innerHTML = '';
            
            try {
                const response = await fetch(`${url}/api/tags`);
                if (!response.ok) throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${response.status}`);
                const data = await response.json();
                
                if (!data.models || data.models.length === 0) {
                    statusEl.textContent = 'æ‰¾ä¸åˆ°ä»»ä½•æ¨¡å‹ã€‚';
                    selectEl.innerHTML = '<option value="">æ‰¾ä¸åˆ°æ¨¡å‹</option>';
                    return;
                }

                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    selectEl.appendChild(option);
                });
                
                if(this.settings.ollamaModel) {
                    selectEl.value = this.settings.ollamaModel;
                }

                statusEl.textContent = `æˆåŠŸæ‰¾åˆ° ${data.models.length} å€‹æ¨¡å‹ï¼`;
            } catch (error) {
                console.error("Fetch Ollama Models Error:", error);
                statusEl.textContent = `ç²å–å¤±æ•—: ${error.message}`;
                selectEl.innerHTML = '<option value="">ç²å–å¤±æ•—</option>';
            }
        },

        // --- Core Logic ---
        async handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const bankNameInput = document.getElementById('ai-bank-name');
            if (!bankNameInput.value.trim()) {
                bankNameInput.value = file.name.replace(/\.[^/.]+$/, "");
            }

            const fileType = file.type;
            let textContent = '';
            try {
                if (fileType === 'application/pdf') {
                    this.showLoading('æ­£åœ¨è®€å– PDF æª”æ¡ˆ...');
                    textContent = await this.readPdf(file);
                } else if (fileType.startsWith('image/')) {
                    textContent = await this.readImage(file);
                } else {
                    this.showAlert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ã€‚è«‹ä¸Šå‚³ PDF æˆ–åœ–ç‰‡æª”ã€‚');
                    return;
                }
                document.getElementById('ai-text-input').value = textContent;
                this.showAlert('æ–‡å­—å·²æˆåŠŸæ“·å–ä¸¦å¡«å…¥æ–‡å­—æ¡†ï¼');
            } catch (error) {
                console.error("File processing error:", error);
                this.showAlert(`è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š ${error.message}`);
            } finally {
                this.hideLoading();
                event.target.value = '';
            }
        },

        async readPdf(file) {
            const typedarray = new Uint8Array(await file.arrayBuffer());
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            return text;
        },

        async readImage(file) {
            this.showLoading('æ­£åœ¨æº–å‚™æ–‡å­—è¾¨è­˜å¼•æ“...');
            const worker = await Tesseract.createWorker('chi_tra', 1, {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        this.showLoading(`æ­£åœ¨è¾¨è­˜åœ–ç‰‡æ–‡å­—... ${Math.round(m.progress * 100)}%`);
                    }
                },
            });
            this.showLoading('æ­£åœ¨è¾¨è­˜åœ–ç‰‡æ–‡å­—... 0%');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            return text;
        },
        
        resetMaterialModal() {
            document.getElementById('ai-bank-name').value = '';
            document.getElementById('ai-pair-type').value = '';
            document.getElementById('ai-num-pairs').value = '15';
            document.getElementById('ai-text-input').value = '';
        },

        async handleAIGenerate() {
            const bankName = document.getElementById('ai-bank-name').value.trim();
            const pairType = document.getElementById('ai-pair-type').value.trim();
            const numPairs = document.getElementById('ai-num-pairs').value;
            const textContent = document.getElementById('ai-text-input').value.trim();

            if (!bankName || !pairType || !textContent) {
                this.showAlert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼šé¡Œåº«åç¨±ã€é…å°é¡å‹ã€ä»¥åŠæ•™ææ–‡å­—ã€‚');
                return;
            }
            
            this.closeAllModals();
            this.showLoading('æ­£åœ¨åˆ†æå…§å®¹ä¸¦å‘¼å« AI...');

            try {
                const aiResponse = await this.callAIAPI(textContent, pairType, numPairs);
                const newBank = {
                    id: `bank-${Date.now()}`,
                    name: bankName,
                    col1Name: aiResponse.col1Name || 'é …ç›®1',
                    col2Name: aiResponse.col2Name || 'é …ç›®2',
                    pairs: aiResponse.pairs || []
                };

                if (newBank.pairs.length === 0) {
                    this.showAlert('AI æœªèƒ½ç”Ÿæˆä»»ä½•é…å°ï¼Œè«‹æª¢æŸ¥æ‚¨çš„æ•™æå…§å®¹æˆ–èª¿æ•´é…å°é¡å‹æè¿°ã€‚');
                } else {
                    this.saveBankToDB(newBank, true);
                    this.resetMaterialModal(); // Reset on success
                }
            } catch (error) {
                console.error("AI Generation Error:", error);
                this.showAlert(`ç”Ÿæˆå¤±æ•—ï¼š${error.message}`);
            } finally {
                this.hideLoading();
            }
        },

        async callAIAPI(text, pairType, numPairs) {
            switch (this.settings.aiSource) {
                case 'gemini_api':
                case 'default':
                    return this.callGemini(text, pairType, numPairs);
                case 'ollama':
                    return this.callOllama(text, pairType, numPairs);
                default: 
                    return this.callGemini(text, pairType, numPairs); // Fallback to default
            }
        },

        async callGemini(text, pairType, numPairs) {
            let apiKey = "";
            if (this.settings.aiSource === 'gemini_api') {
                apiKey = this.settings.geminiApiKey;
                if (!apiKey) {
                    throw new Error('å°šæœªè¨­å®š Gemini API Keyã€‚è«‹åœ¨è¨­å®šä¸­è¼¸å…¥ã€‚');
                }
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ•™è‚²å…§å®¹ç”¢ç”Ÿå™¨ï¼Œå°ˆé–€å¾æ–‡æœ¬ä¸­æå–è³‡è¨Šä¾†å»ºç«‹é…å°é¡Œã€‚
            ä»»å‹™ï¼š
            1. æ ¹æ“šä½¿ç”¨è€…æä¾›çš„æ–‡æœ¬å’ŒæœŸæœ›çš„é…å°é¡å‹ï¼Œç”ŸæˆæŒ‡å®šæ•¸é‡çš„é…å°çµ„ã€‚
            2. ç‚ºé€™å…©æ¬„é…å°å‘½åï¼Œä¾‹å¦‚ "æ—èªå–®å­—" å’Œ "ä¸­æ–‡ç¿»è­¯"ã€‚
            3. åš´æ ¼åŸºæ–¼æä¾›çš„æ–‡æœ¬å…§å®¹ï¼Œä¸å¯è™›æ§‹æˆ–æ·»åŠ å¤–éƒ¨è³‡è¨Šã€‚

            è¼¸å‡ºæ ¼å¼ï¼š
            ä½ å¿…é ˆåš´æ ¼å›å‚³ä¸€å€‹ JSON ç‰©ä»¶ï¼Œä¸åŒ…å«ä»»ä½•é¡å¤–æ–‡å­—æˆ– markdown æ¨™è¨˜ã€‚JSON æ ¼å¼å¦‚ä¸‹ï¼š
            {
              "col1Name": "æ¬„ä½1çš„åç¨±",
              "col2Name": "æ¬„ä½2çš„åç¨±",
              "pairs": [
                { "item1": "é …ç›®1a", "item2": "é …ç›®2a" },
                { "item1": "é …ç›®1b", "item2": "é …ç›®2b" }
              ]
            }`;
            
            const userPrompt = `è«‹å¾ä»¥ä¸‹æ–‡æœ¬ä¸­ï¼Œç”Ÿæˆ ${numPairs} çµ„é—œæ–¼ã€Œ${pairType}ã€çš„é…å°é¡Œã€‚\n\næ–‡æœ¬ï¼š\n${text}`;

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: userPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`AI API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}. ${errorBody}`);
            }
            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (!candidate || !candidate.content?.parts?.[0]?.text) {
                throw new Error("AI å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚");
            }
            try {
                return JSON.parse(candidate.content.parts[0].text);
            } catch (e) {
                console.error("Failed to parse AI JSON response:", candidate.content.parts[0].text);
                throw new Error("ç„¡æ³•è§£æ AI å›å‚³çš„ JSON è³‡æ–™ã€‚");
            }
        },

        async callOllama(text, pairType, numPairs) {
            const { ollamaUrl, ollamaModel } = this.settings;
            if (!ollamaUrl || !ollamaModel) {
                throw new Error('å°šæœªè¨­å®š Ollama URL æˆ–é¸æ“‡æ¨¡å‹ã€‚');
            }
            const apiUrl = `${ollamaUrl}/api/generate`;

            const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ•™è‚²å…§å®¹ç”¢ç”Ÿå™¨ï¼Œå°ˆé–€å¾æ–‡æœ¬ä¸­æå–è³‡è¨Šä¾†å»ºç«‹é…å°é¡Œã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„æ–‡æœ¬ç”ŸæˆæŒ‡å®šæ•¸é‡çš„JSONæ ¼å¼é…å°é¡Œã€‚è«‹éµå¾ªä»¥ä¸‹è¦å‰‡ï¼š1. ç‚ºå…©æ¬„é…å°å‘½åã€‚2. ç”Ÿæˆ ${numPairs} çµ„é—œæ–¼ã€Œ${pairType}ã€çš„é…å°ã€‚3. æ‰€æœ‰å…§å®¹å¿…é ˆå®Œå…¨åŸºæ–¼æä¾›çš„æ–‡æœ¬ã€‚4. ä½ çš„å›ç­”å¿…é ˆæ˜¯å–®ä¸€ä¸”æ ¼å¼æ­£ç¢ºçš„JSONç‰©ä»¶ï¼Œä¸è¦æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—ã€‚`;
            const fullPrompt = `${systemPrompt}\n\næ–‡æœ¬å…§å®¹å¦‚ä¸‹ï¼š\n\`\`\`\n${text}\n\`\`\`\nè«‹ç”Ÿæˆ JSONï¼š`;
            
            const payload = {
                model: ollamaModel,
                prompt: fullPrompt,
                format: "json",
                stream: false
            };

            const response = await fetch(apiUrl, { method: 'POST', body: JSON.stringify(payload) });
            if (!response.ok) {
                throw new Error(`Ollama API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`);
            }
            const result = await response.json();
            if (!result.response) {
                throw new Error("Ollama å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚");
            }
            try {
                const cleanedText = result.response.replace(/^`{3}json\n?/, '').replace(/\n?`{3}$/, '');
                return JSON.parse(cleanedText);
            } catch (e) {
                console.error("Failed to parse Ollama JSON response:", result.response);
                throw new Error("ç„¡æ³•è§£æ Ollama å›å‚³çš„ JSON è³‡æ–™ã€‚");
            }
        },

        handleBatchAdd() {
            const bankName = document.getElementById('new-bank-name').value.trim();
            const col1Name = document.getElementById('col1-name').value.trim() || 'é …ç›®1';
            const col2Name = document.getElementById('col2-name').value.trim() || 'é …ç›®2';
            const text = document.getElementById('batch-input-text').value.trim();

            if (!bankName || !text) {
                this.showAlert('è«‹è¼¸å…¥é¡Œåº«åç¨±å’Œé…å°å…§å®¹ï¼');
                return;
            }

            try {
                const pairs = this.parseMatchingFormat(text);
                if (pairs.length === 0) {
                    this.showAlert('æ²’æœ‰æˆåŠŸè§£æä»»ä½•é…å°ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚');
                    return;
                }

                const newBank = {
                    id: `bank-${Date.now()}`,
                    name: bankName,
                    col1Name: col1Name,
                    col2Name: col2Name,
                    pairs: pairs
                };

                this.saveBankToDB(newBank, true);
                this.closeAllModals();
                this.showAlert(`æˆåŠŸå»ºç«‹é¡Œåº«ã€Œ${bankName}ã€ä¸¦æ–°å¢ ${pairs.length} çµ„é…å°ï¼`);
            } catch (error) {
                this.showAlert(`å»ºç«‹é¡Œåº«å¤±æ•—ï¼š${error.message}`);
            }
        },
        
        parseMatchingFormat(text) {
            const pairs = [];
            const lines = text.split('\n').filter(line => line.trim() !== '');
            for (const line of lines) {
                const parts = line.split(/[\t,]/); // Split by tab or comma
                if (parts.length >= 2) {
                    const item1 = parts[0].trim();
                    const item2 = parts.slice(1).join(' ').trim(); // Join rest in case of comma in item2
                    if (item1 && item2) {
                        pairs.push({ item1, item2 });
                    }
                }
            }
            return pairs;
        },

        // --- DB Operations ---
        saveBankToDB(bank, isNew = false) {
            const transaction = this.db.transaction(["questionBanks"], "readwrite");
            const objectStore = transaction.objectStore("questionBanks");
            const request = objectStore.put(bank);
            request.onsuccess = () => {
                if (isNew) this.loadBanksFromDB();
            };
            request.onerror = (event) => console.error("Error saving bank to DB:", event.target.errorCode);
        },

        loadBanksFromDB() {
            this.questionBanks = [];
            const objectStore = this.db.transaction("questionBanks").objectStore("questionBanks");
            objectStore.openCursor().onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    this.questionBanks.push(cursor.value);
                    cursor.continue();
                } else {
                    this.renderBankList();
                }
            };
        },
        
        async deleteBank(id) {
            const confirmed = await this.showConfirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é¡Œåº«å—ï¼Ÿ");
            if (!confirmed) return;
            
            const request = this.db.transaction(["questionBanks"], "readwrite").objectStore("questionBanks").delete(id);
            request.onsuccess = () => {
                this.selectedBankIds.delete(id);
                this.loadBanksFromDB();
            };
        },


        // --- UI Rendering ---
        renderBankList() {
            const listEl = document.getElementById('bank-list');
            listEl.innerHTML = this.questionBanks.length === 0 ? '<p class="text-gray-500">å°šæœªå»ºç«‹ä»»ä½•é¡Œåº«ã€‚</p>' : '';
            if (this.questionBanks.length === 0) {
                this.updateQuizButtonState();
                return;
            }

            this.questionBanks.forEach(bank => {
                const totalPairs = (bank.pairs || []).length;
                const bankEl = document.createElement('div');
                bankEl.className = 'p-3 bg-white border border-gray-200 rounded-lg flex items-center justify-between gap-2 hover:bg-gray-50';
                bankEl.innerHTML = `
                    <div class="flex items-center flex-grow overflow-hidden">
                        <input type="checkbox" data-id="${bank.id}" class="bank-checkbox h-5 w-5 mr-3 flex-shrink-0 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" ${this.selectedBankIds.has(bank.id) ? 'checked' : ''}>
                        <div class="truncate">
                            <p class="font-bold truncate text-gray-800">${this.escapeHTML(bank.name)}</p>
                            <p class="text-sm text-gray-500">${totalPairs} çµ„é…å°</p>
                        </div>
                    </div>
                    <div class="flex-shrink-0 flex gap-2">
                        <button data-id="${bank.id}" class="edit-bank-btn text-sm bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold px-3 py-1 rounded-md transition-colors">ç·¨è¼¯</button>
                        <button data-id="${bank.id}" class="delete-bank-btn bg-red-500 hover:bg-red-600 text-white font-bold w-8 h-8 rounded-md transition-colors">X</button>
                    </div>
                `;
                listEl.appendChild(bankEl);
            });

            // Re-attach event listeners after rendering
            this.updateQuizButtonState();
            document.querySelectorAll('.bank-checkbox').forEach(cb => cb.addEventListener('change', (e) => {
                const id = e.target.dataset.id;
                e.target.checked ? this.selectedBankIds.add(id) : this.selectedBankIds.delete(id);
                this.updateQuizButtonState();
            }));
            document.querySelectorAll('.delete-bank-btn').forEach(btn => btn.addEventListener('click', (e) => this.deleteBank(e.currentTarget.dataset.id)));
            document.querySelectorAll('.edit-bank-btn').forEach(btn => btn.addEventListener('click', (e) => this.openEditModal(e.currentTarget.dataset.id)));
        },
        
        updateQuizButtonState() {
            const disabled = this.selectedBankIds.size === 0;
            document.getElementById('generate-quiz-btn-auto').disabled = disabled;
            document.getElementById('generate-quiz-btn-manual').disabled = disabled;
            if (disabled) {
                document.getElementById('quiz-preview').classList.add('hidden');
                this.currentQuiz = [];
            }
        },

        // --- Quiz Generation & Export ---
        generatePracticeQuiz(mode) {
            if (this.selectedBankIds.size === 0) return this.showAlert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¡Œåº«ï¼");

            if (mode === 'auto') {
                const numPairs = parseInt(document.getElementById('num-pairs').value, 10);
                let allAvailablePairs = [];
                this.questionBanks.forEach(bank => {
                    if (this.selectedBankIds.has(bank.id)) {
                        const pairsWithContext = (bank.pairs || []).map(p => ({...p, bankName: bank.name}));
                        allAvailablePairs.push(...pairsWithContext);
                    }
                });
                
                if(allAvailablePairs.length === 0) return this.showAlert("é¸ä¸­çš„é¡Œåº«ä¸­æ²’æœ‰ä»»ä½•é…å°é¡Œç›®ã€‚");
                
                this.currentQuiz = allAvailablePairs.sort(() => 0.5 - Math.random()).slice(0, numPairs);
                this.renderQuizPreview();
            } else if (mode === 'manual') {
                this.openManualSelectModal();
            }
        },
        
        openManualSelectModal() {
            const contentEl = document.getElementById('manual-select-content');
            contentEl.innerHTML = '';
            let pairCounter = 0;

            this.questionBanks.forEach(bank => {
                if (this.selectedBankIds.has(bank.id)) {
                    (bank.pairs || []).forEach(pair => {
                        pairCounter++;
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 mb-2 border rounded-md hover:bg-gray-100';
                        const pairData = this.escapeHTML(JSON.stringify(pair));
                        itemEl.innerHTML = `
                            <label class="flex items-start">
                                <input type="checkbox" class="manual-pair-checkbox h-5 w-5 mt-1 mr-3 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" data-pair='${pairData}'>
                                <div>
                                    <p>${this.escapeHTML(pair.item1)} â†”ï¸ ${this.escapeHTML(pair.item2)}</p>
                                    <p class="text-sm text-gray-500">(${this.escapeHTML(bank.name)})</p>
                                </div>
                            </label>
                        `;
                        contentEl.appendChild(itemEl);
                    });
                }
            });

            if (pairCounter === 0) {
                return this.showAlert('é¸ä¸­çš„é¡Œåº«ä¸­æ²’æœ‰é¡Œç›®å¯ä¾›é¸æ“‡ã€‚');
            }
            this.openModal('manual-select-modal');
        },

        generateManualQuiz() {
            const selectedPairs = [];
            document.querySelectorAll('.manual-pair-checkbox:checked').forEach(checkbox => {
                selectedPairs.push(JSON.parse(checkbox.dataset.pair));
            });
            
            if (selectedPairs.length === 0) {
                return this.showAlert('æ‚¨æ²’æœ‰é¸æ“‡ä»»ä½•é¡Œç›®ï¼');
            }

            this.currentQuiz = selectedPairs;
            this.renderQuizPreview();
            this.closeAllModals();
        },

        renderQuizPreview() {
            const previewEl = document.getElementById('quiz-preview');
            const listEl = document.getElementById('quiz-preview-list');
            if (this.currentQuiz.length === 0) {
                previewEl.classList.add('hidden');
                return;
            }
            listEl.innerHTML = '';
            this.currentQuiz.forEach((pair, index) => {
                const pairEl = document.createElement('div');
                pairEl.className = 'mb-2 pb-2 border-b border-dashed border-gray-200 flex justify-between items-center';
                pairEl.innerHTML = `
                    <div class="flex-1">${index + 1}. ${this.escapeHTML(pair.item1)}</div>
                    <div class="mx-2 text-gray-400">â†”ï¸</div>
                    <div class="flex-1">${this.escapeHTML(pair.item2)}</div>
                `;
                listEl.appendChild(pairEl);
            });
            previewEl.classList.remove('hidden');
        },

        exportQuiz(format) {
            if (this.currentQuiz.length === 0) {
                this.showAlert("æ²’æœ‰å¯åŒ¯å‡ºçš„ç·´ç¿’é¡Œã€‚");
                return;
            }
            
            const col1First = document.querySelector('input[name="export-order"]:checked').value === 'col1_first';
            let content = "";
            const separator = '\t';

            this.currentQuiz.forEach(pair => {
                const col1 = pair.item1;
                const col2 = pair.item2;
                const row = col1First ? [col1, col2] : [col2, col1];
                content += row.join(separator) + "\r\n";
            });
            
            this.downloadFile(content, `matching_quiz_${format}_${Date.now()}.txt`, 'text/plain;charset=utf-8;');
        },
        
        async downloadGameWithQuiz(gameUrl) {
            if (this.currentQuiz.length === 0) {
                this.showAlert('è«‹å…ˆç”Ÿæˆç·´ç¿’é¡Œï¼');
                return;
            }

            this.showLoading('æ­£åœ¨è¼‰å…¥éŠæˆ²ä¸¦å¡«å…¥é¡Œåº«...');
            try {
                const response = await fetch(gameUrl);
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥éŠæˆ² HTML (ç‹€æ…‹: ${response.status})`);
                }
                let gameHTML = await response.text();
                
                const quizData = this.convertQuizForMatchingGame();
                
                gameHTML = this.injectQuizIntoGameHTML(gameHTML, quizData);

                const gameName = gameUrl.split('/').pop().split('.html')[0];
                this.downloadFile(gameHTML, `${gameName}_${Date.now()}.html`, 'text/html;charset=utf-8;');

            } catch (error) {
                console.error('ä¸‹è¼‰éŠæˆ²å¤±æ•—:', error);
                this.showAlert(`ä¸‹è¼‰éŠæˆ²å¤±æ•—ï¼š${error.message}`);
            } finally {
                this.hideLoading();
            }
        },

        convertQuizForMatchingGame() {
            const col1First = document.querySelector('input[name="export-order"]:checked').value === 'col1_first';
            let content = "";
            const separator = '\t';

            this.currentQuiz.forEach(pair => {
                const col1 = pair.item1;
                const col2 = pair.item2;
                const row = col1First ? [col1, col2] : [col2, col1];
                content += row.join(separator) + "\r\n";
            });
            return content.trim();
        },

        injectQuizIntoGameHTML(gameHTML, quizData) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(gameHTML, 'text/html');
            const textarea = doc.querySelector('textarea');

            if (textarea) {
                textarea.textContent = quizData;
            } else {
                console.warn('åœ¨éŠæˆ² HTML ä¸­æ‰¾ä¸åˆ° <textarea>ï¼Œé¡Œåº«å¯èƒ½ç„¡æ³•æ­£ç¢ºå¡«å…¥ã€‚');
            }

            return `<!DOCTYPE html>\n${doc.documentElement.outerHTML}`;
        },

        downloadFile(content, fileName, contentType) {
            const blob = new Blob([`\uFEFF${content}`], { type: contentType });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        },

        // --- Edit Modal ---
        openEditModal(bankId) {
            this.editingBankId = bankId;
            const bank = this.questionBanks.find(b => b.id === bankId);
            if (!bank) return;
            
            document.getElementById('edit-modal-title').textContent = `ç·¨è¼¯é¡Œåº«: ${this.escapeHTML(bank.name)}`;
            const contentEl = document.getElementById('edit-modal-content');
            contentEl.innerHTML = `
                <div class="mb-4">
                    <label class="font-bold text-gray-700">é¡Œåº«åç¨±:</label>
                    <input type="text" id="edit-bank-name" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" value="${this.escapeHTML(bank.name)}">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="font-bold text-gray-700">é …ç›®1 æ¬„ä½å:</label>
                        <input type="text" id="edit-col1-name" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" value="${this.escapeHTML(bank.col1Name || 'é …ç›®1')}">
                    </div>
                    <div>
                        <label class="font-bold text-gray-700">é …ç›®2 æ¬„ä½å:</label>
                        <input type="text" id="edit-col2-name" class="w-full border-gray-300 rounded-md shadow-sm p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" value="${this.escapeHTML(bank.col2Name || 'é …ç›®2')}">
                    </div>
                </div>
                <div id="edit-pairs-container" class="space-y-2"></div>
                <button id="add-pair-btn" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 text-sm px-3 py-1 mt-4 rounded-md font-semibold transition-colors">æ–°å¢ä¸€çµ„é…å°</button>
            `;
            
            const container = contentEl.querySelector('#edit-pairs-container');
            (bank.pairs || []).forEach((pair, index) => {
                container.appendChild(this.createPairEditRow(pair, index));
            });

            contentEl.querySelector('#add-pair-btn').addEventListener('click', () => {
                const newIndex = container.children.length;
                container.appendChild(this.createPairEditRow({item1: '', item2: ''}, newIndex, true));
            });
            
            this.openModal('edit-bank-modal');
        },

        createPairEditRow(pair, index, isNew = false) {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-11 gap-2 items-center';
            row.dataset.index = index;
            row.innerHTML = `
                <div class="col-span-5">
                    <input type="text" class="w-full border-gray-300 rounded-md shadow-sm p-2 item1-input focus:ring-indigo-500 focus:border-indigo-500" value="${this.escapeHTML(pair.item1)}">
                </div>
                <div class="text-center text-gray-400">â†”ï¸</div>
                <div class="col-span-5">
                    <input type="text" class="w-full border-gray-300 rounded-md shadow-sm p-2 item2-input focus:ring-indigo-500 focus:border-indigo-500" value="${this.escapeHTML(pair.item2)}">
                </div>
                <button class="delete-pair-btn bg-red-200 hover:bg-red-300 text-red-800 text-sm w-full h-full rounded-md font-semibold transition-colors">X</button>
            `;
            row.querySelector('.delete-pair-btn').addEventListener('click', (e) => {
                e.target.closest('[data-index]').remove();
            });
            if (isNew) {
                row.querySelector('.item1-input').focus();
            }
            return row;
        },

        saveBankEdits() {
            const bank = this.questionBanks.find(b => b.id === this.editingBankId);
            if (!bank) return;

            bank.name = document.getElementById('edit-bank-name').value.trim();
            bank.col1Name = document.getElementById('edit-col1-name').value.trim();
            bank.col2Name = document.getElementById('edit-col2-name').value.trim();
            
            const newPairs = [];
            document.querySelectorAll('#edit-pairs-container [data-index]').forEach(row => {
                const item1 = row.querySelector('.item1-input').value.trim();
                const item2 = row.querySelector('.item2-input').value.trim();
                if (item1 && item2) {
                    newPairs.push({ item1, item2 });
                }
            });
            bank.pairs = newPairs;
            
            this.saveBankToDB(bank);
            this.closeAllModals();
            this.renderBankList();
            this.showAlert('è®Šæ›´å·²å„²å­˜ï¼');
        },

        // --- Data Import/Export ---
        createSampleCSVLink() {
            const container = document.getElementById('csv-sample-link-container');
            if (!container) return;

            const sampleCSV = `bankName,col1Name,col2Name,item1,item2\r\nç¬¬ä¸€èª²ç”Ÿå­—,åœ‹å­—,æ³¨éŸ³,è˜‹æœ,ã„†ã„§ã„¥ËŠ ã„ã„¨ã„›Ë‡\r\nç¬¬ä¸€èª²ç”Ÿå­—,åœ‹å­—,æ³¨éŸ³,é¦™è•‰,ã„’ã„§ã„¤ ã„ã„§ã„ \r\nç¬¬äºŒèª²è©å½™,è‹±æ–‡,"ä¸­æ–‡,å«é€—è™Ÿ","Hello, World!","ä½ å¥½, ä¸–ç•Œï¼"`;
            const blob = new Blob([`\uFEFF${sampleCSV}`], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            container.innerHTML = `æ ¼å¼ï¼šbankName, col1Name, col2Name, item1, item2<br><a href="${url}" download="sample.csv" class="text-indigo-600 hover:underline font-semibold">ä¸‹è¼‰ CSV ç¯„ä¾‹æª”</a>`;
        },

        exportAllData() {
            if (this.questionBanks.length === 0) return this.showAlert("æ²’æœ‰ä»»ä½•è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚");
            
            const header = "bankName,col1Name,col2Name,item1,item2";
            const csvRows = [header];

            const escapeCSV = (field) => {
                if (field === null || field === undefined) return '';
                const str = String(field);
                // If the field contains a comma, a quote, or a newline, wrap it in double quotes.
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    // Escape double quotes by doubling them
                    const escapedStr = str.replace(/"/g, '""');
                    return `"${escapedStr}"`;
                }
                return str;
            };

            this.questionBanks.forEach(bank => {
                (bank.pairs || []).forEach(pair => {
                    const row = [
                        escapeCSV(bank.name),
                        escapeCSV(bank.col1Name),
                        escapeCSV(bank.col2Name),
                        escapeCSV(pair.item1),
                        escapeCSV(pair.item2)
                    ].join(',');
                    csvRows.push(row);
                });
            });

            const csvContent = csvRows.join('\r\n');
            this.downloadFile(csvContent, 'ai_matching_quiz_backup.csv', 'text/csv');
        },

        importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csvText = e.target.result;
                    const lines = csvText.trim().split(/\r?\n/);
                    if (lines.length < 2) throw new Error("CSV æª”æ¡ˆéœ€è¦è‡³å°‘åŒ…å«æ¨™é ­å’Œä¸€è¡Œè³‡æ–™ã€‚");

                    const headerLine = lines.shift();
                    const headers = headerLine.split(',').map(h => h.trim());
                    const requiredHeaders = ['bankName', 'col1Name', 'col2Name', 'item1', 'item2'];
                    if (!requiredHeaders.every(h => headers.includes(h))) {
                        throw new Error(`CSV æ¨™é ­ä¸æ­£ç¢ºã€‚æ‡‰åŒ…å«: ${requiredHeaders.join(', ')}`);
                    }

                    const rows = lines.map(line => {
                        const values = line.match(/(".*?"|[^",\n\r]+)(?=\s*,|\s*$)/g) || [];
                        const rowData = {};
                        headers.forEach((header, index) => {
                            let value = (values[index] || '').trim();
                            if (value.startsWith('"') && value.endsWith('"')) {
                                value = value.slice(1, -1).replace(/""/g, '"');
                            }
                            rowData[header] = value;
                        });
                        return rowData;
                    });
                    
                    const banksToImport = {};
                    rows.forEach(row => {
                        const { bankName, col1Name, col2Name, item1, item2 } = row;
                        if (!bankName || !item1 || !item2) return; // Skip invalid rows
                        
                        if (!banksToImport[bankName]) {
                            banksToImport[bankName] = {
                                id: `bank-${Date.now()}-${Object.keys(banksToImport).length}`,
                                name: bankName,
                                col1Name: col1Name || 'é …ç›®1',
                                col2Name: col2Name || 'é …ç›®2',
                                pairs: []
                            };
                        }
                        banksToImport[bankName].pairs.push({ item1, item2 });
                    });

                    const importedBanks = Object.values(banksToImport);
                    if (importedBanks.length === 0) throw new Error("åœ¨ CSV ä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆçš„é¡Œåº«è³‡æ–™ã€‚");
                    
                    importedBanks.forEach(bank => this.saveBankToDB(bank));
                    
                    setTimeout(() => {
                        this.loadBanksFromDB();
                        this.showAlert(`æˆåŠŸåŒ¯å…¥ ${importedBanks.length} å€‹é¡Œåº«ï¼`);
                        this.closeAllModals();
                    }, 500);

                } catch (error) {
                    this.showAlert(`åŒ¯å…¥å¤±æ•—ï¼š${error.message}`);
                } finally {
                    event.target.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        },

        escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        },
    };

    window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
